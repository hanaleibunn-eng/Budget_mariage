<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Budget Mariage - Version Finale</title>
    <style>
        :root {
            --bg: #1a1a1a;
            --card-bg: #2d2d2d;
            --text: #e0e0e0;
            --highlight: #4caf50;
            --input-bg: #3d3d3d;
            --unpaid: #ff5252;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 15px; padding-bottom: 160px; }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; text-align: right; }

        .container { max-width: 500px; margin: 0 auto; }
        .card { background: var(--card-bg); border-radius: 15px; margin-bottom: 20px; padding: 15px; border: 1px solid #3d3d3d; position: relative; }
        
        .card-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 8px; }

        .card-body { display: flex; gap: 10px; align-items: center; }
        .col-left { flex: 0.8; }
        .col-right { flex: 1.2; display: flex; flex-direction: column; gap: 10px; }

        .input-group { position: relative; display: flex; flex-direction: column; }
        .row-payeur { display: flex; align-items: center; gap: 8px; }
        .row-payeur input[type="number"] { flex-grow: 1; }

        .pay-check { width: 22px; height: 22px; cursor: pointer; accent-color: var(--highlight); }

        label { font-size: 0.65rem; color: #aaa; text-transform: uppercase; margin-bottom: 2px; }
        input { padding: 10px 8px; border: none; border-radius: 8px; font-size: 1rem; background: var(--input-bg); color: white; }
        .input-cout { background: #444; border: 1px solid #555; font-weight: bold; width: 100%; box-sizing: border-box; }

        .is-paid-field { background: rgba(74, 175, 80, 0.2) !important; border: 1px solid var(--highlight) !important; }

        .comment-group { margin-top: 15px; border-top: 1px dashed #555; padding-top: 10px; }
        .comment-input { width: 100%; box-sizing: border-box; background: rgba(0,0,0,0.3); font-size: 0.85rem; font-style: italic; }

        .sticky-footer { position: fixed; bottom: 0; left: 0; right: 0; background: #000; padding: 15px 20px; box-shadow: 0 -8px 20px rgba(0,0,0,0.6); z-index: 100; }
        .progress-container { height: 6px; background: #333; border-radius: 3px; margin-bottom: 10px; overflow: hidden; }
        #progressBar { height: 100%; background: var(--highlight); width: 0%; transition: width 0.5s; }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        .stat-row.main { font-size: 1.1rem; font-weight: bold; color: var(--highlight); }
        
        .btn-save { width: 100%; padding: 15px; background: var(--highlight); color: white; border: none; border-radius: 12px; font-weight: bold; margin-bottom: 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Budget Mariage</h1>
        <div id="cardsContainer"></div>
        <button class="btn-save" id="saveButton">ENREGISTRER LES MODIFICATIONS</button>

        <div class="sticky-footer">
            <div class="progress-container"><div id="progressBar"></div></div>
            <div class="stat-row main">
                <span>Déjà Payé</span>
                <span><span id="totalPaid">0</span> €</span>
            </div>
            <div class="stat-row" style="font-size: 0.85rem; color: #bbb;">
                <span>Budget Total : <span id="totalGlobal">0</span> €</span>
                <span>Reste : <span id="totalRemaining" style="color:var(--unpaid)">0</span> €</span>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAJoAI9wBPbCAgF7wiOZKhS4z2rIvpUTFY",
            authDomain: "budget-mariage-d42dd.firebaseapp.com",
            databaseURL: "https://budget-mariage-d42dd-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "budget-mariage-d42dd",
            storageBucket: "budget-mariage-d42dd.appspot.com",
            messagingSenderId: "367332205562",
            appId: "1:367332205562:web:689620436d467770f3f380"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const budgetRef = ref(db, 'weddingBudget');

        const categories = ["Lieu de réception", "Fiançailles Maroc", "Traiteur", "Cocktail / Alcool", "Voiture : Christophe", "Location sono", "Déco / Activités", "Saxophoniste", "Brunch", "Photographe", "Alliances", "Pièce-Montée", "Robe", "Coiffure / maquillage", "Costume"];

        const container = document.getElementById('cardsContainer');

        // Génération du HTML
        categories.forEach(cat => {
            const card = document.createElement('div');
            card.className = 'card';
    
            // On prépare le contenu des payeurs séparément pour éviter les erreurs d'imbrication
            let payeursHtml = ['adil', 'hanalei', 'parents'].map(p => {
                return `
                    <div class="input-group">
                        <label>${p}</label>
                        <div class="row-payeur">
                            <input type="checkbox" class="pay-check check-trigger" data-cat="${cat}" data-field="check_${p}">
                            <input type="number" inputmode="decimal" class="val-trigger" data-cat="${cat}" data-field="${p}" value="0">
                        </div>
                    </div>`;
            }).join('');

            card.innerHTML = `
                <div class="card-title">${cat}</div>
                <div class="card-body">
                    <div class="col-left">
                        <div class="input-group">
                            <label>Coût Total</label>
                            <input type="number" inputmode="decimal" class="input-cout val-trigger" data-cat="${cat}" data-field="cout" value="0">
                        </div>
                    </div>
                    <div class="col-right">
                        ${payeursHtml}
                    </div>
                </div>
                <div class="comment-group">
                    <input type="text" class="comment-input" data-cat="${cat}" data-field="note" placeholder="Note...">
                </div>
            `;
            container.appendChild(card);
        });

        // Fonction de calcul globale
        function updateEverything() {
            let globalTotal = 0;
            let paidTotal = 0;

            categories.forEach(cat => {
                const coutVal = parseFloat(document.querySelector(`input[data-cat="${cat}"][data-field="cout"]`).value) || 0;
                globalTotal += coutVal;

                ['adil', 'hanalei', 'parents'].forEach(p => {
                    const row = document.querySelector(`input[data-cat="${cat}"][data-field="${p}"]`);
                    const check = document.querySelector(`input[data-cat="${cat}"][data-field="check_${p}"]`);
                    
                    if(check.checked) {
                        row.classList.add('is-paid-field');
                        paidTotal += parseFloat(row.value) || 0;
                    } else {
                        row.classList.remove('is-paid-field');
                    }
                });
            });

            const remaining = globalTotal - paidTotal;
            const percent = globalTotal > 0 ? (paidTotal / globalTotal) * 100 : 0;

            document.getElementById('totalGlobal').innerText = globalTotal.toLocaleString();
            document.getElementById('totalPaid').innerText = paidTotal.toLocaleString();
            document.getElementById('totalRemaining').innerText = remaining.toLocaleString() + " €";
            document.getElementById('progressBar').style.width = percent + "%";
        }

        // Ecouteurs d'événements
        container.addEventListener('input', updateEverything);
        container.addEventListener('change', (e) => {
            if(e.target.classList.contains('pay-check')) updateEverything();
        });

        // Chargement initial
        onValue(budgetRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                categories.forEach(cat => {
                    if (data[cat]) {
                        ['cout', 'adil', 'hanalei', 'parents', 'note'].forEach(f => {
                            const i = document.querySelector(`input[data-cat="${cat}"][data-field="${f}"]`);
                            if(i) i.value = data[cat][f] || (f === 'note' ? '' : 0);
                        });
                        ['adil', 'hanalei', 'parents'].forEach(p => {
                            const c = document.querySelector(`input[data-cat="${cat}"][data-field="check_${p}"]`);
                            if(c) c.checked = data[cat][`check_${p}`] || false;
                        });
                    }
                });
                updateEverything();
            }
        });

        // Gestion de la sauvegarde
        document.getElementById('saveButton').addEventListener('click', () => {
            let dataToSave = {};
            categories.forEach(cat => {
                dataToSave[cat] = {
                    cout: document.querySelector(`input[data-cat="${cat}"][data-field="cout"]`).value || 0,
                    adil: document.querySelector(`input[data-cat="${cat}"][data-field="adil"]`).value || 0,
                    hanalei: document.querySelector(`input[data-cat="${cat}"][data-field="hanalei"]`).value || 0,
                    parents: document.querySelector(`input[data-cat="${cat}"][data-field="parents"]`).value || 0,
                    note: document.querySelector(`input[data-cat="${cat}"][data-field="note"]`).value || "",
                    check_adil: document.querySelector(`input[data-cat="${cat}"][data-field="check_adil"]`).checked,
                    check_hanalei: document.querySelector(`input[data-cat="${cat}"][data-field="check_hanalei"]`).checked,
                    check_parents: document.querySelector(`input[data-cat="${cat}"][data-field="check_parents"]`).checked
                };
            });
            
            set(budgetRef, dataToSave)
                .then(() => alert("✅ Données sauvegardées avec succès !"))
                .catch((error) => alert("❌ Erreur : " + error.message));
        });
    </script>
</body>
</html>